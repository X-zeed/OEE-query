1. เพิ่มข้อมูล lot

insert into lot values
('A001','LINE1','2025-10-22 08:00:00','2025-10-22 12:00:00',20),
('A001','LINE2','2025-10-22 13:00:00','2025-10-22 16:00:00',20);

2. เพิ่มข้อมูล machine_state

insert into machine_state values
('M01','2025-10-22 08:00:00','2025-10-22 10:00:00','PROD'),
('M01','2025-10-22 10:00:00','2025-10-22 10:15:00','UDOWN'),
('M01','2025-10-22 10:15:00','2025-10-22 12:00:00','UPROD'),
('M02','2025-10-22 08:00:00','2025-10-22 10:00:00','UPROD'),
('M02','2025-10-22 10:00:00','2025-10-22 10:15:00','UDOWN'),
('M02','2025-10-22 10:15:00','2025-10-22 12:00:00','PROD'),
('M03','2025-10-22 08:00:00','2025-10-22 10:00:00','PROD'),
('M03','2025-10-22 10:00:00','2025-10-22 10:15:00','UDOWN'),
('M03','2025-10-22 10:15:00','2025-10-22 12:00:00','PROD'),
('M04','2025-10-22 08:00:00','2025-10-22 10:00:00','PROD'),
('M04','2025-10-22 10:00:00','2025-10-22 10:15:00','UDOWN'),
('M04','2025-10-22 10:15:00','2025-10-22 12:00:00','PROD'),
('M05','2025-10-22 08:00:00','2025-10-22 10:00:00','PROD'),
('M05','2025-10-22 10:00:00','2025-10-22 10:15:00','UDOWN'),
('M05','2025-10-22 10:15:00','2025-10-22 12:00:00','PROD'),
('M06','2025-10-22 08:00:00','2025-10-22 10:00:00','PROD'),
('M06','2025-10-22 10:00:00','2025-10-22 10:15:00','UDOWN'),
('M06','2025-10-22 10:15:00','2025-10-22 12:00:00','PROD'),

('M07','2025-10-22 08:00:00','2025-10-22 10:00:00','PROD'),
('M07','2025-10-22 10:00:00','2025-10-22 10:15:00','UDOWN'),
('M07','2025-10-22 10:15:00','2025-10-22 12:00:00','PROD'),
('M08','2025-10-22 13:00:00','2025-10-22 14:00:00','PROD'),
('M08','2025-10-22 14:00:00','2025-10-22 14:30:00','UDOWN'),
('M08','2025-10-22 14:30:00','2025-10-22 15:30:00','PROD'),
('M08','2025-10-22 15:30:00','2025-10-22 15:40:00','UDOWN'),
('M08','2025-10-22 15:40:00','2025-10-22 16:00:00','PROD'),
('M09','2025-10-22 13:00:00','2025-10-22 14:00:00','PROD'),
('M09','2025-10-22 14:00:00','2025-10-22 14:30:00','UDOWN'),
('M09','2025-10-22 14:30:00','2025-10-22 15:30:00','PROD'),
('M09','2025-10-22 15:30:00','2025-10-22 15:40:00','UDOWN'),
('M09','2025-10-22 15:40:00','2025-10-22 16:00:00','PROD'),
('M10','2025-10-22 13:00:00','2025-10-22 14:00:00','PROD'),
('M10','2025-10-22 14:00:00','2025-10-22 14:30:00','UDOWN'),
('M10','2025-10-22 14:30:00','2025-10-22 15:30:00','PROD'),
('M10','2025-10-22 15:30:00','2025-10-22 15:40:00','UDOWN'),
('M10','2025-10-22 15:40:00','2025-10-22 16:00:00','PROD'),
('M11','2025-10-22 13:00:00','2025-10-22 14:00:00','PROD'),
('M11','2025-10-22 14:00:00','2025-10-22 14:30:00','UDOWN'),
('M11','2025-10-22 14:30:00','2025-10-22 15:30:00','PROD'),
('M11','2025-10-22 15:30:00','2025-10-22 15:40:00','UDOWN'),
('M11','2025-10-22 15:40:00','2025-10-22 16:00:00','PROD'),
('M12','2025-10-22 13:00:00','2025-10-22 14:00:00','PROD'),
('M12','2025-10-22 14:00:00','2025-10-22 14:30:00','UDOWN'),
('M12','2025-10-22 14:30:00','2025-10-22 15:30:00','PROD'),
('M12','2025-10-22 15:30:00','2025-10-22 15:40:00','UDOWN'),
('M12','2025-10-22 15:40:00','2025-10-22 16:00:00','PROD'),
('M13','2025-10-22 13:00:00','2025-10-22 14:00:00','PROD'),
('M13','2025-10-22 14:00:00','2025-10-22 14:30:00','UDOWN'),
('M13','2025-10-22 14:30:00','2025-10-22 15:30:00','PROD'),
('M13','2025-10-22 15:30:00','2025-10-22 15:40:00','UDOWN'),
('M13','2025-10-22 15:40:00','2025-10-22 16:00:00','PROD');

3. เพิ่มข้อมูลจาก sensor
insert into ss_reject values
('LINE1','2025-10-22 08:30:00'),
('LINE1','2025-10-22 09:30:00'),
('LINE1','2025-10-22 10:00:00'),
('LINE1','2025-10-22 10:20:00');

insert into ss_good values
('LINE1','2025-10-22 08:40:00'),
('LINE1','2025-10-22 09:40:00'),
('LINE1','2025-10-22 10:10:00'),
('LINE1','2025-10-22 10:30:00'),
('LINE1','2025-10-22 10:31:00'),
('LINE1','2025-10-22 10:35:00'),
('LINE1','2025-10-22 10:40:00'),
('LINE1','2025-10-22 11:45:00');

insert into ss_output values
('LINE1','2025-10-22 08:31:00'),
('LINE1','2025-10-22 09:31:00'),
('LINE1','2025-10-22 10:01:00'),
('LINE1','2025-10-22 10:21:00'),
('LINE1','2025-10-22 08:41:00'),
('LINE1','2025-10-22 09:41:00'),
('LINE1','2025-10-22 10:11:00'),
('LINE1','2025-10-22 10:31:00'),
('LINE1','2025-10-22 10:32:00'),
('LINE1','2025-10-22 10:36:00'),
('LINE1','2025-10-22 10:41:00'),
('LINE1','2025-10-22 11:46:00');

4. run report preocess 

--1 Reject
UPDATE lot ll
SET qty_rej = r.reject_count
FROM (
    SELECT l.lot_id, COUNT(*) AS reject_count
    FROM ss_reject r
    JOIN lot l
      ON r.input_time >= l.start_time
     AND r.input_time < l.end_time
    GROUP BY l.lot_id
) AS r
WHERE ll.lot_id = r.lot_id
  AND ll.line_id = 'LINE1';
--2 Good
UPDATE lot ll
SET qty_good = g.good_count
FROM (
    SELECT l.lot_id, COUNT(*) AS good_count
    FROM ss_good g
    JOIN lot l
      ON g.input_time >= l.start_time
     AND g.input_time < l.end_time
    GROUP BY l.lot_id
) AS g
WHERE ll.lot_id = g.lot_id
  AND ll.line_id = 'LINE2';
--3 Output
UPDATE lot ll
SET qty_out = g.output_count
FROM (
    SELECT l.lot_id, COUNT(*) AS output_count
    FROM ss_output o
    JOIN lot l
      ON o.input_time >= l.start_time
     AND o.input_time < l.end_time
    GROUP BY l.lot_id
) AS g
WHERE ll.lot_id = g.lot_id;
--4 Update to lot
---------------------
UPDATE lot AS l
SET 
    qty_good = v.qty_good,
    qty_rej = v.qty_rej,
    qty_out = v.qty_out
FROM v_quality_lot AS v
WHERE l.lot_id = v.lot_id
  AND l.line_id = v.line_id;



5. ดูผลลัพธ์
select distinct * from v_oee where oee > 0;
