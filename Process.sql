1. เพิ่มข้อมูล lot

insert into lot values
('A004','LINE1','2025-10-15 08:00:00','2025-10-15 12:00:00',20),
('A004','LINE2','2025-10-15 13:00:00','2025-10-15 16:00:00',20);

2. เพิ่มข้อมูล machine_state
insert into machine_state values
('M01','2025-10-15 08:00:00','2025-10-15 10:00:00','PROD'),
('M01','2025-10-15 10:00:00','2025-10-15 10:15:00','DOWN'),
('M01','2025-10-15 10:15:00','2025-10-15 12:00:00','PROD'),
('M02','2025-10-15 08:00:00','2025-10-15 10:00:00','PROD'),
('M02','2025-10-15 10:00:00','2025-10-15 10:15:00','DOWN'),
('M02','2025-10-15 10:15:00','2025-10-15 12:00:00','PROD'),
('M03','2025-10-15 08:00:00','2025-10-15 10:00:00','PROD'),
('M03','2025-10-15 10:00:00','2025-10-15 10:15:00','DOWN'),
('M03','2025-10-15 10:15:00','2025-10-15 12:00:00','PROD'),
('M04','2025-10-15 08:00:00','2025-10-15 10:00:00','PROD'),
('M04','2025-10-15 10:00:00','2025-10-15 10:15:00','DOWN'),
('M04','2025-10-15 10:15:00','2025-10-15 12:00:00','PROD'),
('M05','2025-10-15 08:00:00','2025-10-15 10:00:00','PROD'),
('M05','2025-10-15 10:00:00','2025-10-15 10:15:00','DOWN'),
('M05','2025-10-15 10:15:00','2025-10-15 12:00:00','PROD'),
('M06','2025-10-15 08:00:00','2025-10-15 10:00:00','PROD'),
('M06','2025-10-15 10:00:00','2025-10-15 10:15:00','DOWN'),
('M06','2025-10-15 10:15:00','2025-10-15 12:00:00','PROD'),
('M07','2025-10-15 08:00:00','2025-10-15 10:00:00','PROD'),
('M07','2025-10-15 10:00:00','2025-10-15 10:15:00','DOWN'),
('M07','2025-10-15 10:15:00','2025-10-15 12:00:00','PROD'),
  
('M08','2025-10-15 13:00:00','2025-10-15 14:00:00','PROD'),
('M08','2025-10-15 14:00:00','2025-10-15 14:30:00','DOWN'),
('M08','2025-10-15 14:30:00','2025-10-15 15:30:00','PROD'),
('M08','2025-10-15 15:30:00','2025-10-15 15:40:00','DOWN'),
('M08','2025-10-15 15:40:00','2025-10-15 16:00:00','PROD'),
('M09','2025-10-15 13:00:00','2025-10-15 14:00:00','PROD'),
('M09','2025-10-15 14:00:00','2025-10-15 14:30:00','DOWN'),
('M09','2025-10-15 14:30:00','2025-10-15 15:30:00','PROD'),
('M09','2025-10-15 15:30:00','2025-10-15 15:40:00','DOWN'),
('M09','2025-10-15 15:40:00','2025-10-15 16:00:00','PROD'),
('M10','2025-10-15 13:00:00','2025-10-15 14:00:00','PROD'),
('M10','2025-10-15 14:00:00','2025-10-15 14:30:00','DOWN'),
('M10','2025-10-15 14:30:00','2025-10-15 15:30:00','PROD'),
('M10','2025-10-15 15:30:00','2025-10-15 15:40:00','DOWN'),
('M10','2025-10-15 15:40:00','2025-10-15 16:00:00','PROD'),
('M11','2025-10-15 13:00:00','2025-10-15 14:00:00','PROD'),
('M11','2025-10-15 14:00:00','2025-10-15 14:30:00','DOWN'),
('M11','2025-10-15 14:30:00','2025-10-15 15:30:00','PROD'),
('M11','2025-10-15 15:30:00','2025-10-15 15:40:00','DOWN'),
('M11','2025-10-15 15:40:00','2025-10-15 16:00:00','PROD'),
('M12','2025-10-15 13:00:00','2025-10-15 14:00:00','PROD'),
('M12','2025-10-15 14:00:00','2025-10-15 14:30:00','DOWN'),
('M12','2025-10-15 14:30:00','2025-10-15 15:30:00','PROD'),
('M12','2025-10-15 15:30:00','2025-10-15 15:40:00','DOWN'),
('M12','2025-10-15 15:40:00','2025-10-15 16:00:00','PROD'),
('M13','2025-10-15 13:00:00','2025-10-15 14:00:00','PROD'),
('M13','2025-10-15 14:00:00','2025-10-15 14:30:00','DOWN'),
('M13','2025-10-15 14:30:00','2025-10-15 15:30:00','PROD'),
('M13','2025-10-15 15:30:00','2025-10-15 15:40:00','DOWN'),
('M13','2025-10-15 15:40:00','2025-10-15 16:00:00','PROD');

3. เพิ่มข้อมูลจาก sensor
insert into ss_reject values
('LINE1','2025-10-15 08:30:00'),
('LINE1','2025-10-15 09:30:00'),
('LINE1','2025-10-15 10:00:00'),
('LINE1','2025-10-15 10:20:00'),
('LINE1','2025-10-15 11:15:00');

insert into ss_good values
('LINE2','2025-10-15 13:00:00'),
('LINE2','2025-10-15 13:30:00'),
('LINE2','2025-10-15 13:45:00'),
('LINE2','2025-10-15 13:50:00'),
('LINE2','2025-10-15 13:55:00'),
('LINE2','2025-10-15 14:00:00'),
('LINE2','2025-10-15 14:10:00'),
('LINE2','2025-10-15 14:25:00'),
('LINE2','2025-10-15 14:50:00'),
('LINE2','2025-10-15 14:55:00'),
('LINE2','2025-10-15 14:57:00'),
('LINE2','2025-10-15 15:20:00'),
('LINE2','2025-10-15 15:45:00'),
('LINE2','2025-10-15 15:50:00'),
('LINE2','2025-10-15 16:00:00');

4. run report preocess 
--2 Reject
UPDATE lot ll
SET qty_rej = r.reject_count
FROM (
    SELECT l.lot_id, COUNT(*) AS reject_count
    FROM ss_reject r
    JOIN lot l
      ON r.input_time >= l.start_time
     AND r.input_time < l.end_time
    GROUP BY l.lot_id
) AS r
WHERE ll.lot_id = r.lot_id
  AND ll.line_id = 'LINE1';

--3 Good
UPDATE lot ll
SET qty_out = g.good_count
FROM (
    SELECT l.lot_id, COUNT(*) AS good_count
    FROM ss_good r
    JOIN lot l
      ON r.input_time >= l.start_time
     AND r.input_time < l.end_time
    GROUP BY l.lot_id
) AS g
WHERE ll.lot_id = g.lot_id
  AND ll.line_id = 'LINE2';
---------------------
UPDATE lot AS l
SET 
    qty_out = v.qty_out,
    qty_rej = v.qty_rej
FROM v_quality_lot AS v
WHERE l.lot_id = v.lot_id
  AND l.line_id = v.line_id;
---------------------
