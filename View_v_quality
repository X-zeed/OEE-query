DROP VIEW IF EXISTS v_quality;

CREATE VIEW v_quality AS
SELECT 
    line_id, 
    txndate, 
    SUM(qty_in) AS qty_in,
    SUM(
        CASE 
            WHEN line_id = 'LINE1' THEN qty_in - qty_rej
            ELSE qty_out
        END
    ) AS qty_out,
    SUM(
        CASE 
            WHEN line_id = 'LINE2' THEN qty_in - qty_out
            ELSE qty_rej
        END
    ) AS qty_rej
FROM (
    SELECT DISTINCT
        line_id,
        start_time,
        CAST(start_time AS DATE) AS txndate,
        COALESCE(qty_in, 0) AS qty_in,
        COALESCE(qty_out, 0) AS qty_out,
        COALESCE(qty_rej, 0) AS qty_rej
    FROM lot
) AS sub
GROUP BY line_id, txndate;
